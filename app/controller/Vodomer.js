/*
 * File: app/controller/Vodomer.js
 * Date: Mon Aug 03 2020 19:38:17 GMT+0300 (EEST)
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('yis.controller.Vodomer', {
    extend: 'Ext.app.Controller',

    control: {
        "#grVodomer": {
            selectionchange: 'onGrVodomerSelectionChange'
        },
        "#insTekPokVod": {
            click: 'onInsTekPokVodClick'
        },
        "#grAppHVodomer": {
            selectionchange: 'onGrAppHVodomerSelectionChange'
        },
        "#grAllPokVodomera": {
            selectionchange: 'onGrAllPokVodomeraSelectionChange'
        },
        "#grAppVodomer": {
            selectionchange: 'onGrAppVodomerSelectionChange'
        },
        "#tabAppVodomer": {
            activate: 'onTabAppVodomerActivate'
        }
    },

    onGrVodomerSelectionChange: function(model, selected, eOpts) {
        //in use
        var me =this;
        var store = Ext.data.StoreManager.get("StWater");
        var storeTekPokVodomera = Ext.data.StoreManager.get("StTekPokVodomera");
        var formVodomer = me.getFmVodomer();
        if (selected.length){
            var address_id = selected[0].data.address_id;
            store.load({
                params: {
                    what:'AllPokVodomera',
                    what_id: selected[0].data.address_id,
                    nomer: selected[0].data.nomer
                },
                scope:this
            });
            store.sync();
            storeTekPokVodomera.load({
                params: {
                    what:'TekPokVodomera',
                    what_id: selected[0].data.address_id,
                    nomer: selected[0].data.nomer
                },
                callback: function(records,operation,success){
                    if(success){
                        storeTekPokVodomera.sync();
                        formVodomer.getForm().loadRecord(records[0]);

                    }
                },
                scope:this
            });

        }

    },

    onInsTekPokVodClick: function(button, e, eOpts) {
        // in use
        var me = this;
        //STORE
        console.log(2);

        var stUser = Ext.data.StoreManager.get("StUser");
        var stWater = Ext.data.StoreManager.get("StWater");//QueryVodomer.getResults  <AppVodomer>
        var stTekPokVodomera = Ext.data.StoreManager.get("StTekPokVodomera");//QueryVodomer.getResults <TekPokVodomera>
        //LOGIN & PASSWORD

        var values =stUser.getAt(0);
        var params = {
            user_id:values.get('user_id'),
            login:values.get('login'),
            password:values.get('password'),
            address_id:values.get('address_id'),
            house_id:values.get('house_id'),
            what:'AVodomer'

        };
        //GRID

        //var grTekNachAppVodomer = Ext.getCmp('grTekNachAppVodomer');

        //FORMA

        var fmVodomer = Ext.getCmp('fmVodomer');
        var value = fmVodomer.getValues();

        //LOGIKA

        Ext.Object.merge(value, params);
        var newValue = value.newValue;
        var max =newValue - value.tek;
        if (isNaN(newValue)){
            Ext.MessageBox.show({
                title: 'Проверка вводимых данных',
                msg: 'Введите число',
                buttons: Ext.MessageBox.OK,
                icon: Ext.MessageBox.ERROR
            });
            return false;
        }else if (max < 0){
            Ext.MessageBox.show({
                title: 'Проверка вводимых данных',
                msg: 'Текущие показания <b>'+value.tek+'</b><br>Новые показания <b>'+newValue+'</b><br>Введите правильные показания !.',
                buttons: Ext.MessageBox.CANCEL,
                icon: Ext.MessageBox.ERROR,
                buttonText:{
                    cancel:'отмена'
                },
                fn:function(btn,newValue){
                    if(btn=='cancel'){
                        fmVodomer.getForm().findField('newValue').focus();
                        return false;
                    }
                }
            });
        } else if(max === 0) {
            Ext.MessageBox.confirm({
                title: 'Проверка вводимых данных',
                msg: 'Вводимые показания теже что и предыдущие<br>Подтвердите или отмените вводимые показания.',
                buttons: Ext.MessageBox.OKCANCEL,
                icon: Ext.MessageBox.ERROR,
                buttonText:{
                    ok:'подтвеждаю',
                    cancel:'отмена'
                },
                fn:function(btn,newValue){
                    if(btn=='cancel'){
                        fmVodomer.getForm().findField('newValue').focus();
                        return false;
                    }else{
                        QueryVodomer.newPokVodomera(value,function(results){
                            if (results.success){

                                fmVodomer.getForm().findField('newValue').setValue(0);
                                stWater.load({
                                    params: {
                                        what:'AllPokVodomera',
                                        what_id: value.address_id,
                                        address_id: value.address_id,
                                        vodomer_id: value.vodomer_id,
                                        login:value.login,
                                        password:value.password
                                    },
                                    scope:this
                                });
                                stTekPokVodomera.load({
                                    params: {
                                        what:'TekPokVodomera',
                                        what_id: value.address_id,
                                        address_id: value.address_id,
                                        vodomer_id: value.vodomer_id,
                                        login:value.login,
                                        password:value.password
                                    },
                                    callback: function(records,operation,success){
                                        if(success){
                                            fmVodomer.getForm().loadRecord(records[0]);
                                        }
                                    },
                                    scope:this
                                });
                            }
                        });
                    }
                }
            });
        } else if(max > 20) {
            Ext.MessageBox.confirm({
                title: 'Проверка вводимых данных',
                msg: 'Вводимые показания <b>'+newValue+'</b> очень большие <b>'+ max +'</b> куб(a)<br>Подтвердите или отмените вводимые показания.',
                buttons: Ext.MessageBox.OKCANCEL,
                icon: Ext.MessageBox.ERROR,
                buttonText:{
                    ok:'подтвеждаю',
                    cancel:'отмена'
                },
                fn:function(btn,newValue){
                    if(btn=='cancel'){
                        fmVodomer.getForm().findField('newValue').focus();
                        return false;
                    }else{
                        QueryVodomer.newPokVodomera(value,function(results){
                            if (results.success){

                                fmVodomer.getForm().findField('newValue').setValue(0);
                                stWater.load({
                                    params: {
                                        what:'AllPokVodomera',
                                        what_id: value.address_id,
                                        address_id: value.address_id,
                                        vodomer_id: value.vodomer_id,
                                        login:value.login,
                                        password:value.password
                                    },
                                    scope:this
                                });
                                stTekPokVodomera.load({
                                    params: {
                                        what:'TekPokVodomera',
                                        what_id: value.address_id,
                                        address_id: value.address_id,
                                        vodomer_id: value.vodomer_id,
                                        login:value.login,
                                        password:value.password
                                    },
                                    callback: function(records,operation,success){
                                        if(success){
                                            fmVodomer.getForm().loadRecord(records[0]);
                                        }
                                    },
                                    scope:this
                                });
                            }
                        });
                    }
                }
            });


        } else {
            QueryVodomer.newPokVodomera(value,function(results){
                if (results.success){

                    fmVodomer.getForm().findField('newValue').setValue(0);
                    stWater.load({
                        params: {
                            what:'AllPokVodomera',
                            what_id: value.address_id,
                            address_id: value.address_id,
                            vodomer_id: value.vodomer_id,
                            login:value.login,
                            password:value.password
                        },
                        scope:this
                    });

                    stTekPokVodomera.load({
                        params: {
                            what:'TekPokVodomera',
                            what_id: value.address_id,
                            address_id: value.address_id,
                            vodomer_id: value.vodomer_id,
                            login:value.login,
                            password:value.password
                        },
                        callback: function(records,operation,success){
                            if(success){
                                fmVodomer.getForm().loadRecord(records[0]);
                            }
                        },
                        scope:this
                    });

                }
            });
        }

    },

    onGrAppHVodomerSelectionChange: function(model, selected, eOpts) {
           //in use
                var me =this;

                //STORE

                var stUser = Ext.data.StoreManager.get("StUser");
                var stWater = Ext.data.StoreManager.get("StWater");//QueryVodomer.getResults  <AllPokVodomera>
                var stTekPokVodomera = Ext.data.StoreManager.get("StTekPokVodomera");//QueryVodomer.getResults <TekPokVodomera>

                //LOGIN & PASSWORD

                var values =stUser.getAt(0);
                var login = values.get('login');
                var password = values.get('password');
                var address_id = values.get('address_id');
                var house_id = values.get('house_id');

                //GRID

                var grAppVodomer = Ext.getCmp('grAppVodomer');

                //FORMA

                var fmVodomer = Ext.getCmp('fmVodomer');

                //LOGIKA

                grAppVodomer.getView().getSelectionModel().deselectAll();

                if (selected.length){
                    stTekPokVodomera.removeAll();

                    stWater.load({
                        params: {
                            login:login,
                            password:password,
                            address_id: address_id,
                            what:'AllPokVodomera',
                            what_id: selected[0].data.address_id,
                            vodomer_id: selected[0].data.vodomer_id
                        },
                        scope:this
                    });
                    fmVodomer.getForm().reset();

                }

    },

    onGrAllPokVodomeraSelectionChange: function(model, selected, eOpts) {

        //LOGIN & PASSWORD
        var form = Ext.getCmp('fmVodomer');
        if (selected.length > 0) {
            form.getForm().reset();
            form.getForm().loadRecord(selected[0]);
        }
    },

    onGrAppVodomerSelectionChange: function(model, selected, eOpts) {
        //in use
        //console.log(selected[0].data);
        //STORE

        var stUser = Ext.data.StoreManager.get("StUser");
        var stWater = Ext.data.StoreManager.get("StWater");
        var stTekPokVodomera = Ext.data.StoreManager.get("StTekPokVodomera");

        //LOGIN & PASSWORD

        var values =stUser.getAt(0);
        var login = values.get('login');
        var address_id = values.get('address_id');

        //GRID

        var grAppHVodomer = Ext.getCmp('grAppHVodomer');

        //FORMA

        var fmVodomer = Ext.getCmp('fmVodomer');


        //var tekValue = fmVodomer.getForm().findField('tekp');
        //var newValue = fmVodomer.getForm().findField('newValue');


        //LOGIKA

        grAppHVodomer.getView().getSelectionModel().deselectAll();

        if (selected.length){
            stWater.load({
                params: {
                    address_id: address_id,
                    what:'AllPokVodomera',
                    what_id: selected[0].data.address_id,
                    vodomer_id: selected[0].data.vodomer_id
                },
                scope:this
            });
            stTekPokVodomera.load({
                params: {
                    address_id: address_id,
                    what:'TekPokVodomera',
                    what_id: selected[0].data.address_id,
                    vodomer_id: selected[0].data.vodomer_id
                },
                callback: function(records,operation,success){
                    if(success){
                        fmVodomer.getForm().loadRecord(records[0]);

                    }
                },
                scope:this
            });

            // if (tekValue.isHidden()) {tekValue.show();}
        }

    },

    onTabAppVodomerActivate: function(component, eOpts) {
        var stUser = Ext.data.StoreManager.get("StUser");
        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var address_id = values.get('address_id');
        var address = values.get('address');
        var house_id = values.get('house_id');

        var fmVodomer = Ext.getCmp('fmVodomer');
        var grAllPokVodomera = Ext.getCmp('grAllPokVodomera');

        //STORE
        var stVodomer = Ext.data.StoreManager.get("StVodomer");
        var stHVodomer = Ext.data.StoreManager.get("StHVodomer");
        var StWater = Ext.data.StoreManager.get("StWater");
        var stTekPokVodomera = Ext.data.StoreManager.get("StTekPokVodomera");

        stVodomer.removeAll();
        stHVodomer.removeAll();
        StWater.removeAll();
        stTekPokVodomera.removeAll();


        fmVodomer.setTitle('Технічна характеристика будинку');

        fmVodomer.getForm().reset();
        fmVodomer.expand(true);

        stVodomer.load({
            params: {
                what:'AppVodomer',
                what_id: address_id,
                address_id: address_id,
                login:login,
                password:password
            },
            scope:this
        });

        stHVodomer.load({
            params: {
                what:'AppHVodomer',
                what_id: address_id,
                address_id: address_id,
                login:login,
                password:password
            },
            scope:this
        });

    }

});
